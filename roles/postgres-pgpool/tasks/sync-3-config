#!/usr/bin/env bash
set -e

PPETC="/etc/pgpool2"

# After a provision, we won't have a conf.in
if [ -f "$PPETC/pgpool.conf" ] && [ ! -f "$PPETC/pgpool.conf.in" ] ; then
  sudo mv "$PPETC/pgpool.conf" "$PPETC/pgpool.conf.in"
fi

cat << EOF | sudo tee "$PPETC/pgpool.conf" > /dev/null
# Warning: This file is generated by cult from pgpool.conf.in and dynamic.conf
# See logic in: <%= __FILE__ %>
EOF

sudo cat "$PPETC/pgpool.conf.in" "$PPETC/dynamic.conf" | \
  sudo tee -a "$PPETC/pgpool.conf" > /dev/null

sudo systemctl start pgpool2
sudo systemctl reload pgpool2
