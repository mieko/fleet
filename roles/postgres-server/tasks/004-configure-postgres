#!/usr/bin/env bash
set -e


PGETC=/etc/postgresql/<%= node.definition['pg_version'] %>/main

# Note: we accept connections from anyone, but in practice:
# the listen address is just on the smaller "sortranet".
cat - <<PG_HBA | sudo tee -a "$PGETC/pg_hba.conf"
# GENERATED IN CULT PROJECT: <%= __FILE__ %>
hostssl  all          all          255.255.255.255/0  cert clientcert=1 map=cert
hostssl  all          all          ::1/0              cert clientcert=1 map=cert

# Allow replication using the same cert
hostssl  replication  replication  255.255.255.255/0  cert clientcert=1 map=cert
hostssl  replication  replication  ::1/0              cert clientcert=1 map=cert

PG_HBA

cat - <<PG_IDENT | sudo tee -a "$PGETC/pg_ident.conf"
# GENERATED IN CULT PROJECT: <%= __FILE__ %>
cert             postgres-client    metermd
cert             postgres-server    metermd
cert             postgres-server    replication
PG_IDENT

# Comment out any SSL settings
sudo sed -i.bak -e 's/^ssl/#ssl/;' "$PGETC/postgresql.conf"
<%
  listen_addresses = ['localhost', node.ipv4_private, node.ipv6_private].compact.join(',')
%>

cat - <<PG_CONF | sudo tee -a "$PGETC/postgresql.conf"
# GENERATED IN CULT PROJECT: <%= __FILE__ %>
listen_addresses = '*'
ssl = true
ssl_ciphers = 'EECDH+AESGCM:AES256+EECDH'
ssl_prefer_server_ciphers = on
ssl_ecdh_curve = 'prime256v1'

ssl_ca_file   = '/etc/ssl/metermd/metermd-ca.crt'
ssl_cert_file = '/etc/ssl/metermd/postgres-server.crt'
ssl_key_file  = '/etc/ssl/metermd/postgres-server.key'

# Static, many overwritten in dynamic.conf
max_connections = 300
max_wal_senders = 100
wal_level = logical
wal_keep_segments = 6

include '$PGETC/dynamic.conf'
PG_CONF

cat - <<DYNAMIC_CONF | sudo tee -a "$PGETC/dynamic.conf"
# This file is generated by the initial deploy task, but is overwritten by the
# sync task.  It will overwrite many settings in postgresql.conf with data once
# it knows the layout.
DYNAMIC_CONF
